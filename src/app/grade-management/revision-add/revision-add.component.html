<div class="revision-add-container">
  <div class="header-section">
    <button class="back-btn" (click)="goBack()">â† æˆ»ã‚‹</button>
    <h1 class="page-title">éšæ™‚æ”¹å®šã§ç­‰ç´šè¿½åŠ </h1>
  </div>

  <!-- å¾“æ¥­å“¡æƒ…å ± -->
  <div class="employee-info-section">
    <h3>å¾“æ¥­å“¡æƒ…å ±</h3>

    <div class="loading" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div class="error-message" *ngIf="errorMessage && !isLoading">
      <p>{{ errorMessage }}</p>
    </div>

    <div class="employee-details" *ngIf="employeeInfo && !isLoading">
      <div class="info-row">
        <span class="label">å¾“æ¥­å“¡å:</span>
        <span class="value">{{ employeeInfo.name }}</span>
      </div>
      <div class="info-row">
        <span class="label">å¾“æ¥­å“¡ç•ªå·:</span>
        <span class="value">{{ employeeInfo.employeeNumber }}</span>
      </div>
      <div class="info-row">
        <span class="label">ç”Ÿå¹´æœˆæ—¥:</span>
        <span class="value">{{ employeeInfo.birthDate }}</span>
      </div>
      <div class="info-row">
        <span class="label">å¹´é½¢:</span>
        <span class="value">{{ employeeInfo.age }}æ­³</span>
      </div>
      <div class="info-row">
        <span class="label">äº‹æ¥­æ‰€ç•ªå·:</span>
        <span class="value">{{ employeeInfo.branchNumber }}</span>
      </div>
      <div class="info-row">
        <span class="label">äº‹æ¥­æ‰€æ‰€åœ¨åœ°:</span>
        <span class="value">{{ employeeInfo.addressPrefecture }}</span>
      </div>
    </div>
  </div>

  <!-- éšæ™‚æ”¹å®šæƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="grade-input-section">
    <h3>éšæ™‚æ”¹å®šæƒ…å ±å…¥åŠ›</h3>

    <div class="form-content">
      <!-- æ”¹å®šç†ç”± -->
      <div class="form-group">
        <label for="revisionReason">æ”¹å®šç†ç”± *</label>
        <select id="revisionReason" [(ngModel)]="revisionData.revisionReason">
          <option value="">ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          <option *ngFor="let reason of revisionReasons" [value]="reason.value">
            {{ reason.label }}
          </option>
        </select>
        <small class="help-text">å›ºå®šçš„è³ƒé‡‘ã®å¤‰å‹•ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
      </div>

      <!-- æ”¹å®šæ—¥ -->
      <div class="form-group">
        <label for="revisionDate">æ”¹å®šæ—¥ *</label>
        <input type="date" id="revisionDate" [(ngModel)]="revisionData.revisionDate" />
        <small class="help-text">å›ºå®šçš„è³ƒé‡‘ãŒå¤‰å‹•ã—ãŸæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
      </div>

      <!-- æ”¹å®šå‰å¾Œã®å ±é…¬æœˆé¡ -->
      <div class="form-group">
        <div class="section-label">æ”¹å®šå‰å¾Œã®å ±é…¬æœˆé¡ *</div>
        <div class="amount-comparison">
          <div class="amount-input-group">
            <label for="beforeAmount">æ”¹å®šå‰</label>
            <input
              type="number"
              id="beforeAmount"
              [(ngModel)]="revisionData.beforeAmount"
              (ngModelChange)="onAmountChange()"
              placeholder="ä¾‹: 280000"
              min="0"
              step="1"
            />
            <span class="unit">å††</span>
          </div>
          <div class="arrow-icon">â†’</div>
          <div class="amount-input-group">
            <label for="afterAmount">æ”¹å®šå¾Œ</label>
            <input
              type="number"
              id="afterAmount"
              [(ngModel)]="revisionData.afterAmount"
              (ngModelChange)="onAmountChange()"
              placeholder="ä¾‹: 320000"
              min="0"
              step="1"
            />
            <span class="unit">å††</span>
          </div>
        </div>
        <small class="help-text">æ”¹å®šå‰å¾Œã®å›ºå®šçš„è³ƒé‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœˆé¡ï¼‰</small>
      </div>

      <!-- è‘—ã—ãé«˜ä½ã®åˆ¤å®šçµæœè¡¨ç¤º -->
      <div class="form-group" *ngIf="revisionData.beforeAmount && revisionData.afterAmount">
        <div class="section-label">è‘—ã—ãé«˜ä½ã®åˆ¤å®š</div>
        <div class="significant-change-display">
          <span class="change-status" [class.significant]="revisionData.isSignificantChange">
            <span class="status-icon">{{ revisionData.isSignificantChange ? 'âš ï¸' : 'âœ…' }}</span>
            {{
              revisionData.isSignificantChange
                ? 'è‘—ã—ãé«˜ä½ï¼ˆ2ç­‰ç´šä»¥ä¸Šã®å·®ï¼‰'
                : 'é€šå¸¸ç¯„å›²å†…ï¼ˆ1ç­‰ç´šä»¥ä¸‹ã®å·®ï¼‰'
            }}
          </span>
        </div>
        <small class="help-text">ç­‰ç´šåˆ¤å®šã«ãŠã‘ã‚‹è‘—ã—ãé«˜ä½ã®åˆ¤å®šçµæœ</small>
      </div>

      <!-- ç¶™ç¶šæœˆæ•° -->
      <div class="form-group">
        <label for="continuousMonths">ç¶™ç¶šæœˆæ•°</label>
        <select id="continuousMonths" [(ngModel)]="revisionData.continuousMonths">
          <option value="1">1ãƒ¶æœˆ</option>
          <option value="2">2ãƒ¶æœˆ</option>
          <option value="3">3ãƒ¶æœˆ</option>
          <option value="4">4ãƒ¶æœˆ</option>
          <option value="5">5ãƒ¶æœˆ</option>
          <option value="6">6ãƒ¶æœˆ</option>
        </select>
        <small class="help-text">å¤‰å‹•ãŒç¶™ç¶šã™ã‚‹è¦‹è¾¼ã¿æœˆæ•°ï¼ˆé€šå¸¸ã¯3ãƒ¶æœˆä»¥ä¸Šï¼‰</small>
      </div>

      <!-- é©ç”¨é–‹å§‹æœŸé–“ -->
      <div class="form-group" *ngIf="applicableYear && applicableMonth">
        <div class="section-label">é©ç”¨é–‹å§‹æœŸé–“ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
        <div class="applicable-period-display">
          <span class="period-text">{{ applicableYear }}å¹´{{ applicableMonth }}æœˆï½</span>
          <small class="calculation-note">ï¼ˆæ”¹å®šæ—¥ã‹ã‚‰4ãƒ¶æœˆå¾Œã®1æ—¥ã‹ã‚‰é©ç”¨ï¼‰</small>
        </div>
        <small class="help-text">éšæ™‚æ”¹å®šã¯é€šå¸¸ã€å›ºå®šçš„è³ƒé‡‘å¤‰å‹•æœˆã‹ã‚‰4ãƒ¶æœˆå¾Œã«é©ç”¨ã•ã‚Œã¾ã™</small>
      </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ¼ãƒ ä¸‹ã®ãƒœã‚¿ãƒ³ -->
    <div class="form-button-section">
      <button
        type="button"
        class="judgment-btn"
        (click)="calculateGrade()"
        [disabled]="!isFormValid()"
      >
        åˆ¤å®š
      </button>
    </div>
  </div>

  <!-- åˆ¤å®šçµæœè¡¨ç¤º -->
  <div class="result-section" *ngIf="judgmentResult">
    <h3 class="section-title">åˆ¤å®šçµæœ</h3>

    <div class="result-content">
      <!-- é©ç”¨æœŸé–“è¡¨ç¤º -->
      <div class="form-group period-group" *ngIf="applicableYear && applicableMonth">
        <div class="period-label">é©ç”¨æœŸé–“</div>
        <div class="period-display">
          <span class="period-text">{{ applicableYear }}å¹´{{ applicableMonth }}æœˆï½ç¶™ç¶š</span>
        </div>
      </div>

      <!-- æ”¹å®šæ¦‚è¦ -->
      <div class="form-group revision-summary-group">
        <div class="revision-summary-label">æ”¹å®šæ¦‚è¦</div>
        <div class="revision-summary-info">
          <div class="info-item">
            <span class="info-label">æ”¹å®šç†ç”±:</span>
            <span class="info-value">{{
              getRevisionReasonLabel(revisionData.revisionReason)
            }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">æ”¹å®šå‰å ±é…¬:</span>
            <span class="info-value">{{ revisionData.beforeAmount | number }}å††</span>
          </div>
          <div class="info-item">
            <span class="info-label">æ”¹å®šå¾Œå ±é…¬:</span>
            <span class="info-value">{{ revisionData.afterAmount | number }}å††</span>
          </div>
        </div>
      </div>

      <!-- å¥åº·ä¿é™ºç­‰ç´šã®å¤‰æ›´ -->
      <div class="form-group insurance-group">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ¥</span>
          å¥åº·ä¿é™º
        </div>
        <div class="insurance-comparison">
          <div class="before-after-container">
            <div class="before-section">
              <span class="section-title">æ”¹å®šå‰</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult.beforeGrades.healthInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult.beforeGrades.healthInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div class="arrow-section">â†’</div>
            <div class="after-section">
              <span class="section-title">æ”¹å®šå¾Œ</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult.afterGrades.healthInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult.afterGrades.healthInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div class="difference-section">
              <span class="difference-label">å¤‰æ›´</span>
              <span
                class="difference-value"
                [class]="
                  'grade-difference-' +
                  getGradeDifferenceClass(judgmentResult.gradeDifference.healthInsurance)
                "
              >
                {{ getGradeDifferenceText(judgmentResult.gradeDifference.healthInsurance) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- åšç”Ÿå¹´é‡‘ä¿é™ºç­‰ç´šã®å¤‰æ›´ -->
      <div class="form-group insurance-group">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ‘´</span>
          åšç”Ÿå¹´é‡‘ä¿é™º
        </div>
        <div class="insurance-comparison">
          <div class="before-after-container">
            <div class="before-section">
              <span class="section-title">æ”¹å®šå‰</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult.beforeGrades.pensionInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult.beforeGrades.pensionInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div class="arrow-section">â†’</div>
            <div class="after-section">
              <span class="section-title">æ”¹å®šå¾Œ</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult.afterGrades.pensionInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult.afterGrades.pensionInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div class="difference-section">
              <span class="difference-label">å¤‰æ›´</span>
              <span
                class="difference-value"
                [class]="
                  'grade-difference-' +
                  getGradeDifferenceClass(judgmentResult.gradeDifference.pensionInsurance)
                "
              >
                {{ getGradeDifferenceText(judgmentResult.gradeDifference.pensionInsurance) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- ä»‹è­·ä¿é™ºç­‰ç´šã®å¤‰æ›´ -->
      <div class="form-group insurance-group" *ngIf="hasCareInsurance">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ¤</span>
          ä»‹è­·ä¿é™º
        </div>
        <div class="insurance-comparison">
          <div class="before-after-container">
            <div class="before-section">
              <span class="section-title">æ”¹å®šå‰</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult!.beforeGrades.careInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult!.beforeGrades.careInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div class="arrow-section">â†’</div>
            <div class="after-section">
              <span class="section-title">æ”¹å®šå¾Œ</span>
              <div class="grade-info">
                <span class="grade">{{ judgmentResult!.afterGrades.careInsuranceGrade }}ç´š</span>
                <span class="amount"
                  >{{ judgmentResult!.afterGrades.careInsuranceStandardSalary | number }}å††</span
                >
              </div>
            </div>
            <div
              class="difference-section"
              *ngIf="judgmentResult!.gradeDifference.careInsurance !== undefined"
            >
              <span class="difference-label">å¤‰æ›´</span>
              <span
                class="difference-value"
                [class]="
                  'grade-difference-' +
                  getGradeDifferenceClass(judgmentResult!.gradeDifference.careInsurance!)
                "
              >
                {{ getGradeDifferenceText(judgmentResult!.gradeDifference.careInsurance!) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- ä»‹è­·ä¿é™ºå¯¾è±¡å¤–ã®å ´åˆ -->
      <div class="form-group insurance-group" *ngIf="isNoCareInsurance">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ¤</span>
          ä»‹è­·ä¿é™º
        </div>
        <div class="insurance-info not-applicable">
          <div class="info-item">
            <span class="info-value not-applicable-text">å¯¾è±¡å¤–ï¼ˆ40æ­³æœªæº€ï¼‰</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="button-section">
      <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
      <button
        type="button"
        class="save-btn"
        [disabled]="!isSaveValid() || isSaving"
        (click)="saveRevisionData()"
        *ngIf="judgmentResult"
      >
        <span *ngIf="!isSaving">{{ savedRevisionData ? 'æ›´æ–°' : 'ä¿å­˜' }}</span>
        <span *ngIf="isSaving">ä¿å­˜ä¸­...</span>
      </button>

      <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
      <button
        type="button"
        class="delete-btn"
        [disabled]="isSaving"
        (click)="deleteRevisionData()"
        *ngIf="savedRevisionData"
      >
        å‰Šé™¤
      </button>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="message-section" *ngIf="errorMessage">
      <div
        class="message-box"
        [class.success]="
          errorMessage.includes('ä¿å­˜ã•ã‚Œã¾ã—ãŸ') || errorMessage.includes('å‰Šé™¤ã—ã¾ã—ãŸ')
        "
      >
        {{ errorMessage }}
      </div>
    </div>

    <!-- è¨ˆç®—æ ¹æ‹ ã®è¡¨ç¤ºï¼ˆç›£æŸ»ç”¨ï¼‰ -->
    <div class="calculation-snapshot-section" *ngIf="savedRevisionData?.calculationSnapshot">
      <h3 class="snapshot-title">è¨ˆç®—æ ¹æ‹ ï¼ˆç›£æŸ»ç”¨ï¼‰</h3>
      <div class="snapshot-content">
        <div class="snapshot-item">
          <span class="snapshot-label">å¾“æ¥­å“¡åŒºåˆ†:</span>
          <span class="snapshot-value">{{
            savedRevisionData!.calculationSnapshot.employeeCategory
          }}</span>
        </div>
        <div class="snapshot-item">
          <span class="snapshot-label">é©ç”¨ãƒ«ãƒ¼ãƒ«:</span>
          <span class="snapshot-value">{{
            savedRevisionData!.calculationSnapshot.appliedRules.join(', ')
          }}</span>
        </div>
        <div class="snapshot-item">
          <span class="snapshot-label">çŸ›ç›¾ãƒ«ãƒ¼ãƒ«é€šé:</span>
          <span
            class="snapshot-value"
            [class.success]="
              savedRevisionData!.calculationSnapshot.validationResults.passesContradictionRule
            "
          >
            {{
              savedRevisionData!.calculationSnapshot.validationResults.passesContradictionRule
                ? 'é€šé'
                : 'ä¸é€šé'
            }}
          </span>
        </div>
        <div class="snapshot-item">
          <span class="snapshot-label">è¨ˆç®—å®Ÿè¡Œæ—¥æ™‚:</span>
          <span class="snapshot-value">{{
            formatTimestamp(savedRevisionData!.calculationSnapshot.timestamp)
          }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
