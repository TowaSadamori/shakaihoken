<div class="regular-determination-add-container">
  <div class="header-section">
    <button class="back-btn" (click)="goBack()">â† æˆ»ã‚‹</button>
    <h1 class="page-title">å®šæ™‚æ±ºå®šã§ç­‰ç´šè¿½åŠ </h1>
  </div>

  <!-- å¾“æ¥­å“¡æƒ…å ± -->
  <div class="employee-info-section">
    <h3>å¾“æ¥­å“¡æƒ…å ±</h3>

    <div class="loading" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div class="error-message" *ngIf="errorMessage && !isLoading">
      <p>{{ errorMessage }}</p>
    </div>

    <div class="employee-details" *ngIf="employeeInfo && !isLoading">
      <div class="info-row">
        <span class="label">å¾“æ¥­å“¡å:</span>
        <span class="value">{{ employeeInfo.name }}</span>
      </div>
      <div class="info-row">
        <span class="label">å¾“æ¥­å“¡ç•ªå·:</span>
        <span class="value">{{ employeeInfo.employeeNumber }}</span>
      </div>
      <div class="info-row">
        <span class="label">ç”Ÿå¹´æœˆæ—¥:</span>
        <span class="value">{{ employeeInfo.birthDate }}</span>
      </div>
      <div class="info-row">
        <span class="label">å¹´é½¢:</span>
        <span class="value">{{ employeeInfo.age }}æ­³</span>
      </div>
      <div class="info-row">
        <span class="label">äº‹æ¥­æ‰€ç•ªå·:</span>
        <span class="value">{{ employeeInfo.branchNumber }}</span>
      </div>
      <div class="info-row">
        <span class="label">äº‹æ¥­æ‰€æ‰€åœ¨åœ°:</span>
        <span class="value">{{ employeeInfo.addressPrefecture }}</span>
      </div>
    </div>
  </div>

  <!-- å®šæ™‚æ±ºå®šæƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="grade-input-section">
    <h3>å®šæ™‚æ±ºå®šæƒ…å ±å…¥åŠ›</h3>

    <div class="form-content">
      <!-- å¯¾è±¡å¹´åº¦é¸æŠ -->
      <div class="form-group">
        <label for="targetYear">ç®—å®šåŸºç¤å±Šå¯¾è±¡å¹´åº¦ *</label>
        <div class="year-selection-row">
          <select id="targetYear" [(ngModel)]="targetYear" (ngModelChange)="onTargetYearChange()">
            <option *ngFor="let year of availableYears" [value]="year">{{ year }}å¹´</option>
          </select>
          <button
            type="button"
            class="load-salary-btn"
            (click)="loadSalaryDataFromFirestore()"
            title="çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•å–å¾—"
          >
            ğŸ“Š çµ¦ä¸ãƒ‡ãƒ¼ã‚¿å–å¾—
          </button>
          <button
            type="button"
            class="create-test-data-btn"
            (click)="createTestSalaryData()"
            title="ãƒ†ã‚¹ãƒˆç”¨çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"
          >
            ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
          </button>
        </div>
        <small class="help-text"
          >ç®—å®šåŸºç¤å±Šã®å¯¾è±¡ã¨ãªã‚‹å¹´åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚çµ¦ä¸ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒœã‚¿ãƒ³ã§4-6æœˆã®å ±é…¬ã‚’è‡ªå‹•å…¥åŠ›ã§ãã¾ã™ã€‚</small
        >
      </div>

      <!-- 3ãƒ¶æœˆåˆ†ã®å ±é…¬å…¥åŠ› -->
      <div class="form-group">
        <div class="section-label">4æœˆã€œ6æœˆã®å ±é…¬æœˆé¡ *</div>
        <div class="monthly-payments-container">
          <div *ngFor="let payment of monthlyPayments; let i = index" class="monthly-payment-row">
            <div class="month-label">
              <span class="month-icon">ğŸ“…</span>
              {{ getMonthName(payment.month) }}
            </div>
            <div class="payment-inputs">
              <div class="input-group">
                <label [for]="'amount-' + i">å ±é…¬æœˆé¡</label>
                <input
                  type="number"
                  [id]="'amount-' + i"
                  [(ngModel)]="payment.amount"
                  (ngModelChange)="onPaymentChange()"
                  placeholder="ä¾‹: 280000"
                  min="0"
                  step="1"
                />
                <span class="unit">å††</span>
              </div>
              <div class="input-group">
                <label [for]="'workingDays-' + i">ç¨¼åƒæ—¥æ•°</label>
                <input
                  type="number"
                  [id]="'workingDays-' + i"
                  [(ngModel)]="payment.workingDays"
                  placeholder="ä¾‹: 22"
                  min="0"
                  max="31"
                  step="1"
                />
                <span class="unit">æ—¥</span>
              </div>
            </div>
          </div>
        </div>
        <small class="help-text"
          >ç®—å®šåŸºç¤å±Šã®å¯¾è±¡ã¨ãªã‚‹4æœˆã€5æœˆã€6æœˆã®å ±é…¬æœˆé¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€ä½2ãƒ¶æœˆåˆ†å¿…è¦ï¼‰</small
        >
      </div>

      <!-- å¹³å‡å ±é…¬è¡¨ç¤º -->
      <div class="form-group" *ngIf="hasAverageAmount()">
        <div class="section-label">ç®—å®šå¹³å‡å ±é…¬</div>
        <div class="average-display">
          <span class="average-amount">{{ formatAmount(averageAmount) }}å††</span>
          <small class="calculation-note">ï¼ˆå…¥åŠ›ã•ã‚ŒãŸæœˆã®å¹³å‡å€¤ï¼‰</small>
        </div>
      </div>

      <!-- é©ç”¨æœŸé–“å…¥åŠ› -->
      <div class="form-group">
        <label for="applicableYear">é©ç”¨é–‹å§‹å¹´æœˆ *</label>
        <div class="date-input-row">
          <select id="applicableYear" [(ngModel)]="applicableYear">
            <option *ngFor="let year of availableYears" [value]="year">{{ year }}å¹´</option>
          </select>
          <select id="applicableMonth" [(ngModel)]="applicableMonth">
            <option *ngFor="let month of availableMonths" [value]="month.value">
              {{ month.label }}
            </option>
          </select>
        </div>
        <small class="help-text">å®šæ™‚æ±ºå®šã¯é€šå¸¸9æœˆ1æ—¥ã‹ã‚‰é©ç”¨ã•ã‚Œã¾ã™</small>
      </div>

      <!-- é©ç”¨çµ‚äº†æœŸé–“ï¼ˆä»»æ„ï¼‰ -->
      <div class="form-group">
        <label for="endYear">é©ç”¨çµ‚äº†å¹´æœˆï¼ˆä»»æ„ï¼‰</label>
        <div class="date-input-row">
          <select id="endYear" [(ngModel)]="endYear">
            <option value="">å¹´ã‚’é¸æŠ</option>
            <option *ngFor="let year of availableYears" [value]="year">{{ year }}å¹´</option>
          </select>
          <select id="endMonth" [(ngModel)]="endMonth">
            <option value="">æœˆã‚’é¸æŠ</option>
            <option *ngFor="let month of availableMonths" [value]="month.value">
              {{ month.label }}
            </option>
          </select>
        </div>
        <small class="help-text">ç¶™ç¶šé©ç”¨ã®å ´åˆã¯ç©ºæ¬„ã®ã¾ã¾ã«ã—ã¦ãã ã•ã„</small>
      </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ¼ãƒ ä¸‹ã®ãƒœã‚¿ãƒ³ -->
    <div class="form-button-section">
      <button
        type="button"
        class="judgment-btn"
        (click)="calculateGrade()"
        [disabled]="!isFormValid()"
      >
        åˆ¤å®š
      </button>
    </div>
  </div>

  <!-- åˆ¤å®šçµæœè¡¨ç¤º -->
  <div class="result-section" *ngIf="judgmentResult">
    <h3 class="section-title">åˆ¤å®šçµæœ</h3>

    <div class="result-content">
      <!-- é©ç”¨æœŸé–“è¡¨ç¤º -->
      <div class="form-group period-group">
        <div class="period-label">é©ç”¨æœŸé–“</div>
        <div class="period-display">
          <span class="period-text">
            {{ applicableYear }}å¹´{{ applicableMonth }}æœˆ ï½
            <span *ngIf="endYear && endMonth">{{ endYear }}å¹´{{ endMonth }}æœˆ</span>
            <span *ngIf="!endYear || !endMonth">ç¶™ç¶š</span>
          </span>
        </div>
      </div>

      <!-- ç®—å®šåŸºç¤æƒ…å ± -->
      <div class="form-group calculation-group">
        <div class="calculation-label">ç®—å®šåŸºç¤</div>
        <div class="calculation-info">
          <div class="info-item">
            <span class="info-label">å¯¾è±¡å¹´åº¦:</span>
            <span class="info-value">{{ targetYear }}å¹´</span>
          </div>
          <div class="info-item">
            <span class="info-label">å¹³å‡å ±é…¬:</span>
            <span class="info-value">{{ averageAmount | number }}å††</span>
          </div>
        </div>
      </div>

      <!-- å¥åº·ä¿é™º -->
      <div class="form-group insurance-group">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ¥</span>
          å¥åº·ä¿é™º
        </div>
        <div class="insurance-info">
          <div class="info-item">
            <span class="info-label">ç­‰ç´š:</span>
            <span class="info-value">{{ judgmentResult.healthInsuranceGrade }}ç´š</span>
          </div>
          <div class="info-item">
            <span class="info-label">æœˆé¡:</span>
            <span class="info-value"
              >{{ judgmentResult.healthInsuranceStandardSalary | number }}å††</span
            >
          </div>
          <div class="info-item">
            <span class="info-label">æœŸé–“:</span>
            <span class="info-value">
              <span *ngIf="!endYear || !endMonth">ç¶™ç¶š</span>
              <span *ngIf="endYear && endMonth">{{ endYear }}å¹´{{ endMonth }}æœˆã¾ã§</span>
            </span>
          </div>
        </div>
      </div>

      <!-- åšç”Ÿå¹´é‡‘ä¿é™º -->
      <div class="form-group insurance-group">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ‘´</span>
          åšç”Ÿå¹´é‡‘ä¿é™º
        </div>
        <div class="insurance-info">
          <div class="info-item">
            <span class="info-label">ç­‰ç´š:</span>
            <span class="info-value">{{ judgmentResult.pensionInsuranceGrade }}ç´š</span>
          </div>
          <div class="info-item">
            <span class="info-label">æœˆé¡:</span>
            <span class="info-value"
              >{{ judgmentResult.pensionInsuranceStandardSalary | number }}å††</span
            >
          </div>
          <div class="info-item">
            <span class="info-label">æœŸé–“:</span>
            <span class="info-value">
              <span *ngIf="!endYear || !endMonth">ç¶™ç¶š</span>
              <span *ngIf="endYear && endMonth">{{ endYear }}å¹´{{ endMonth }}æœˆã¾ã§</span>
            </span>
          </div>
        </div>
      </div>

      <!-- ä»‹è­·ä¿é™º -->
      <div class="form-group insurance-group">
        <div class="insurance-label">
          <span class="insurance-icon">ğŸ¤</span>
          ä»‹è­·ä¿é™º
        </div>
        <div class="insurance-info" *ngIf="judgmentResult.careInsuranceGrade">
          <div class="info-item">
            <span class="info-label">ç­‰ç´š:</span>
            <span class="info-value">{{ judgmentResult.careInsuranceGrade }}ç´š</span>
          </div>
          <div class="info-item">
            <span class="info-label">æœˆé¡:</span>
            <span class="info-value"
              >{{ judgmentResult.careInsuranceStandardSalary | number }}å††</span
            >
          </div>
          <div class="info-item">
            <span class="info-label">æœŸé–“:</span>
            <span class="info-value">
              <span *ngIf="!endYear || !endMonth">ç¶™ç¶š</span>
              <span *ngIf="endYear && endMonth">{{ endYear }}å¹´{{ endMonth }}æœˆã¾ã§</span>
            </span>
          </div>
        </div>
        <div class="insurance-info not-applicable" *ngIf="!judgmentResult.careInsuranceGrade">
          <div class="info-item">
            <span class="info-value not-applicable-text">å¯¾è±¡å¤–ï¼ˆ40æ­³æœªæº€ï¼‰</span>
          </div>
        </div>
      </div>

      <!-- ä¿å­˜çŠ¶æ…‹è¡¨ç¤º -->
      <div class="form-group save-group" *ngIf="savedGradeData">
        <div class="save-status">
          <span class="save-icon">âœ…</span>
          <span class="save-text">ä¿å­˜æ¸ˆã¿ ({{ getFormattedDate(savedGradeData.updatedAt) }})</span>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="button-section">
      <button
        type="button"
        class="save-btn"
        (click)="saveGradeData()"
        [disabled]="!isSaveValid() || isSaving"
        *ngIf="!savedGradeData"
      >
        <span *ngIf="isSaving">ä¿å­˜ä¸­...</span>
        <span *ngIf="!isSaving">ä¿å­˜</span>
      </button>

      <button
        type="button"
        class="delete-btn"
        (click)="deleteGradeData()"
        [disabled]="isSaving"
        *ngIf="savedGradeData"
      >
        <span *ngIf="isSaving">å‰Šé™¤ä¸­...</span>
        <span *ngIf="!isSaving">å‰Šé™¤</span>
      </button>
    </div>
  </div>
</div>
