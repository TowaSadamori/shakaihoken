<button class="home-button" (click)="goBack()">æˆ»ã‚‹</button>

<h2 class="page-title">è³ä¸ ç¤¾ä¼šä¿é™ºæ–™è¨ˆç®—</h2>

<div class="calculation-container">
  <!-- å¾“æ¥­å“¡æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="employee-info-section" *ngIf="employeeInfo">
    <h3>å¾“æ¥­å“¡æƒ…å ±</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">å¾“æ¥­å“¡ç•ªå·:</span>
        <span>{{ employeeInfo.employeeNumber }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">æ°å:</span>
        <span>{{ employeeInfo.name }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">å¹´é½¢:</span>
        <span>{{ employeeInfo.age }}æ­³</span>
      </div>
      <div class="info-item">
        <span class="info-label">ç”Ÿå¹´æœˆæ—¥:</span>
        <span>{{ formatBirthDate(employeeInfo.birthDate) }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">äº‹æ¥­æ‰€æ‰€åœ¨åœ°:</span>
        <span>{{ employeeInfo.addressPrefecture }}</span>
      </div>
      <div class="info-item" *ngIf="employeeInsurancePeriods.careInsurancePeriod">
        <span class="info-label">ä»‹è­·ä¿é™ºå¯¾è±¡æœŸé–“:</span>
        <span>
          {{ formatJapaneseDate(employeeInsurancePeriods.careInsurancePeriod.start) }} ï½
          {{ formatJapaneseDate(employeeInsurancePeriods.careInsurancePeriod.end) }}
        </span>
      </div>
      <div class="info-item" *ngIf="employeeInsurancePeriods.healthInsurancePeriod">
        <span class="info-label">å¥åº·ä¿é™ºå¯¾è±¡æœŸé–“:</span>
        <span>
          {{ formatJapaneseDate(employeeInsurancePeriods.healthInsurancePeriod.start) }} ï½
          {{ formatJapaneseDate(employeeInsurancePeriods.healthInsurancePeriod.end) }}
        </span>
      </div>
      <div class="info-item" *ngIf="employeeInsurancePeriods.pensionInsurancePeriod">
        <span class="info-label">åšç”Ÿå¹´é‡‘ä¿é™ºå¯¾è±¡æœŸé–“:</span>
        <span>
          {{ formatJapaneseDate(employeeInsurancePeriods.pensionInsurancePeriod.start) }} ï½
          {{ formatJapaneseDate(employeeInsurancePeriods.pensionInsurancePeriod.end) }}
        </span>
      </div>
    </div>
  </div>

  <!-- å¹´åº¦é¸æŠã¨å–ã‚Šè¾¼ã¿ã‚¨ãƒªã‚¢ -->
  <div class="bonus-control-section">
    <h3>è³ä¸æƒ…å ±å–ã‚Šè¾¼ã¿</h3>

    <div class="control-form">
      <div class="form-row">
        <label for="target-year" class="form-label">å¯¾è±¡å¹´åº¦:</label>
        <div class="year-controls">
          <button class="year-nav-btn" (click)="previousYear()">&lt;</button>
          <span class="current-year">{{ formatFiscalYear(targetYear) }}</span>
          <button class="year-nav-btn" (click)="nextYear()">&gt;</button>
          <button class="current-year-btn" (click)="currentYear()">ç¾åœ¨å¹´åº¦</button>
        </div>
      </div>

      <div class="import-button-area">
        <!--
        <button
          class="import-btn"
          (click)="importBonusData()"
          [disabled]="!employeeInfo || isLoading"
        >
          <span *ngIf="isLoading">èª­ã¿è¾¼ã¿ä¸­...</span>
          <span *ngIf="!isLoading">ğŸ“¥ è³ä¸ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿</span>
        </button>
        -->
        <button
          class="add-bonus-btn"
          (click)="showAddBonusForm = true"
          [disabled]="bonusDataList.length >= 3"
          [title]="bonusDataList.length >= 3 ? 'å¹´é–“3å›ã¾ã§ã—ã‹è³ä¸ã‚’è¿½åŠ ã§ãã¾ã›ã‚“' : ''"
        >
          ï¼‹ è³ä¸æƒ…å ±è¿½åŠ 
        </button>
        <div *ngIf="bonusDataList.length >= 3" class="bonus-limit-message">
          å¹´é–“3å›ã¾ã§ã—ã‹è³ä¸ã‚’è¿½åŠ ã§ãã¾ã›ã‚“ï¼ˆç¾åœ¨: {{ bonusDataList.length }}å›ï¼‰
        </div>
      </div>
    </div>

    <app-bonus-add-form
      *ngIf="showAddBonusForm"
      [existingBonusMonths]="getExistingBonusMonths()"
      [isEdit]="false"
      (save)="addBonus($event)"
      (closed)="onAddBonusClosed()"
    ></app-bonus-add-form>

    <app-bonus-add-form
      *ngIf="showEditBonusForm"
      [initialData]="editBonusInitialData || undefined"
      [existingBonusMonths]="getExistingBonusMonths()"
      [isEdit]="true"
      [originalMonth]="
        editBonusInitialData ? editBonusInitialData.paymentDate.substring(0, 7) : undefined
      "
      (save)="onEditBonusSave($event)"
      (closed)="onEditBonusClosed()"
    ></app-bonus-add-form>
  </div>

  <!-- Excelå½¢å¼ã®è¨ˆç®—çµæœè¡¨ -->
  <div class="result-table-section">
    <div style="display: flex; align-items: center; gap: 1rem">
      <h3 style="margin: 0">è³ä¸ç¤¾ä¼šä¿é™ºæ–™è¨ˆç®—çµæœ</h3>
      <button class="save-results-btn" (click)="onSaveBonusResults()">è¨ˆç®—çµæœã‚’ä¿å­˜</button>
    </div>

    <div class="container is-fluid">
      <div *ngIf="employeeInfo" class="mt-5 content">
        <div class="card">
          <header class="card-header">
            <!-- ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¿ã‚¤ãƒˆãƒ«æ¨ªã«é…ç½® -->
          </header>
          <div class="card-content">
            <!-- ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="results-table-container" *ngIf="pivotedTable; else noData">
              <table class="results-table">
                <thead>
                  <tr>
                    <th>æ“ä½œ</th>
                    <th>æ”¯çµ¦å›æ•°ãƒ»æ”¯çµ¦æœˆ</th>
                    <ng-container *ngFor="let col of pivotedTable.columns">
                      <th
                        *ngIf="!col.isSeparator"
                        [innerHTML]="col.header"
                        [class.is-numeric]="col.isNumeric"
                      ></th>
                      <th *ngIf="col.isSeparator" class="separator-col"></th>
                    </ng-container>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of pivotedTable.rows; let rowIndex = index" class="data-row">
                    <td>
                      <button class="edit-btn" (click)="onEditBonus(row.dataIndex)">ç·¨é›†</button>
                      <button class="delete-btn" (click)="onDeleteBonus(row.dataIndex)">
                        å‰Šé™¤
                      </button>
                    </td>
                    <td [innerHTML]="row.header"></td>
                    <ng-container *ngFor="let col of pivotedTable.columns; let i = index">
                      <td *ngIf="!col.isSeparator" [class.is-numeric]="col.isNumeric">
                        <!-- è‚²ä¼‘ç”£ä¼‘åˆ—ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å»ƒæ­¢ã—spanã§æ—¥æœ¬èªè¡¨ç¤º -->
                        <span
                          *ngIf="
                            row.values &&
                            i < row.values.length &&
                            row.values[i] &&
                            row.values[i]!.toString().startsWith('checkbox_')
                          "
                        >
                          {{ getLeaveTypeLabel(getLeaveType(rowIndex)) }}
                        </span>
                        <!-- é€šå¸¸ã®å€¤ã®å ´åˆ -->
                        <span
                          *ngIf="
                            row.values &&
                            i < row.values.length &&
                            row.values[i] &&
                            !row.values[i]!.toString().startsWith('checkbox_')
                          "
                        >
                          {{ row.values[i] }}
                        </span>
                      </td>
                      <td *ngIf="col.isSeparator" class="separator-col"></td>
                    </ng-container>
                  </tr>
                </tbody>
              </table>

              <div *ngIf="errorMessage" class="notification is-danger mt-4">
                <p>
                  <strong>ã‚¨ãƒ©ãƒ¼</strong>
                </p>
                <p>{{ errorMessage }}</p>
              </div>
            </div>

            <ng-template #noData>
              <div *ngIf="isLoading" class="has-text-centered">
                <div class="loader-container">
                  <div class="loader"></div>
                  <span>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
              </div>
              <div *ngIf="!isLoading && !bonusDataList.length" class="has-text-centered">
                <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸Šé™é©ç”¨ã®æ³¨è¨˜ -->
    <div class="notes" *ngIf="hasLimitApplied">
      <h4>âš ï¸ æ³¨è¨˜</h4>
      <ul>
        <li *ngFor="let note of limitNotes">{{ note }}</li>
      </ul>
    </div>
  </div>
</div>
