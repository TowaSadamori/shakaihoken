<button class="home-button" (click)="goBack()">æˆ»ã‚‹</button>

<h2 class="page-title">è³ä¸ ç¤¾ä¼šä¿é™ºæ–™è¨ˆç®—</h2>

<div class="calculation-container">
  <!-- å¾“æ¥­å“¡æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="employee-info-section" *ngIf="employeeInfo">
    <h3>å¾“æ¥­å“¡æƒ…å ±</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">å¾“æ¥­å“¡ç•ªå·:</span>
        <span>{{ employeeInfo.employeeNumber }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">æ°å:</span>
        <span>{{ employeeInfo.name }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">å¹´é½¢:</span>
        <span>{{ employeeInfo.age }}æ­³</span>
      </div>
      <div class="info-item">
        <span class="info-label">äº‹æ¥­æ‰€æ‰€åœ¨åœ°:</span>
        <span>{{ employeeInfo.addressPrefecture }}</span>
      </div>
    </div>
  </div>

  <!-- å¹´åº¦é¸æŠã¨å–ã‚Šè¾¼ã¿ã‚¨ãƒªã‚¢ -->
  <div class="bonus-control-section">
    <h3>è³ä¸æƒ…å ±å–ã‚Šè¾¼ã¿</h3>

    <div class="control-form">
      <div class="form-row">
        <label for="target-year" class="form-label">å¯¾è±¡å¹´åº¦:</label>
        <div class="year-controls">
          <button class="year-nav-btn" (click)="previousYear()">&lt;</button>
          <span class="current-year">{{ formatFiscalYear(targetYear) }}</span>
          <button class="year-nav-btn" (click)="nextYear()">&gt;</button>
          <button class="current-year-btn" (click)="currentYear()">ç¾åœ¨å¹´åº¦</button>
        </div>
      </div>

      <div class="import-button-area">
        <button
          class="import-btn"
          (click)="importBonusData()"
          [disabled]="!employeeInfo || isLoading"
        >
          <span *ngIf="isLoading">èª­ã¿è¾¼ã¿ä¸­...</span>
          <span *ngIf="!isLoading">ğŸ“¥ è³ä¸ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Excelå½¢å¼ã®è¨ˆç®—çµæœè¡¨ -->
  <div class="result-table-section">
    <h3>è³ä¸ç¤¾ä¼šä¿é™ºæ–™è¨ˆç®—çµæœ</h3>

    <div class="excel-table">
      <table>
        <thead>
          <tr class="header-row-1">
            <th rowspan="3">æ”¯çµ¦å¹´æœˆæ—¥</th>
            <th rowspan="3">å ±é…¬é¡</th>
            <th colspan="5">å…¨å›½å¥åº·ä¿é™ºå”ä¼šç®¡æŒå¥åº·ä¿é™ºæ–™</th>
            <th colspan="3">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåšç”Ÿå¹´é‡‘åŸºé‡‘åŠ å…¥å“¡ã‚’é™¤ãï¼‰</th>
          </tr>
          <tr class="header-row-2">
            <th rowspan="2">ç­‰ç´š</th>
            <th colspan="2">ä»‹è­·ä¿é™ºç¬¬2å·è¢«ä¿é™ºè€…<br />ã«è©²å½“ã—ãªã„å ´åˆ</th>
            <th colspan="2">ä»‹è­·ä¿é™ºç¬¬2å·è¢«ä¿é™ºè€…<br />ã«è©²å½“ã™ã‚‹å ´åˆ</th>
            <th rowspan="2">ç­‰ç´š</th>
            <th colspan="2">ä¸€èˆ¬ã€å‘å†…å“¡ãƒ»èˆ¹å“¡</th>
          </tr>
          <tr class="header-row-3">
            <th>å¾“æ¥­å“¡è² æ‹…</th>
            <th>ä¼šç¤¾è² æ‹…</th>
            <th>å¾“æ¥­å“¡è² æ‹…</th>
            <th>ä¼šç¤¾è² æ‹…</th>
            <th>å¾“æ¥­å“¡è² æ‹…</th>
            <th>ä¼šç¤¾è² æ‹…</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bonus of bonusDataList; let i = index">
            <td>{{ bonus.paymentDate || '-' }}</td>
            <td>{{ bonus.amount ? formatAmount(bonus.amount) : '-' }}</td>
            <td>{{ bonus.healthInsuranceGrade || '-' }}</td>
            <!-- 40æ­³æœªæº€ã®å ´åˆï¼ˆä»‹è­·ä¿é™ºç¬¬2å·è¢«ä¿é™ºè€…ã«è©²å½“ã—ãªã„å ´åˆï¼‰ -->
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age < 40; else nonNursingEmpty">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.employeeBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nonNursingEmpty>-</ng-template>
            </td>
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age < 40; else nonNursingEmpty2">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.companyBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nonNursingEmpty2>-</ng-template>
            </td>
            <!-- 40æ­³ä»¥ä¸Šã®å ´åˆï¼ˆä»‹è­·ä¿é™ºç¬¬2å·è¢«ä¿é™ºè€…ã«è©²å½“ã™ã‚‹å ´åˆï¼‰ -->
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age >= 40; else nursingEmpty">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.employeeBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nursingEmpty>-</ng-template>
            </td>
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age >= 40; else nursingEmpty2">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.companyBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nursingEmpty2>-</ng-template>
            </td>
            <td>{{ bonus.pensionInsuranceGrade || '-' }}</td>
            <td>
              {{
                bonus.calculationResult
                  ? formatAmount(bonus.calculationResult.pensionInsurance.employeeBurden)
                  : '-'
              }}
            </td>
            <td>
              {{
                bonus.calculationResult
                  ? formatAmount(bonus.calculationResult.pensionInsurance.companyBurden)
                  : '-'
              }}
            </td>
          </tr>
          <!-- ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ç©ºè¡Œè¡¨ç¤º -->
          <tr *ngIf="bonusDataList.length === 0">
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ä¸Šé™é©ç”¨ã®æ³¨è¨˜ -->
    <div class="notes" *ngIf="hasLimitApplied">
      <h4>âš ï¸ æ³¨è¨˜</h4>
      <ul>
        <li *ngFor="let note of limitNotes">{{ note }}</li>
      </ul>
    </div>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
    <div *ngIf="errorMessage.includes('ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹')" class="index-guidance">
      <p><strong>è§£æ±ºæ–¹æ³•:</strong></p>
      <ol>
        <li>
          <a
            href="https://console.firebase.google.com/project/kensyu10093/firestore/indexes"
            target="_blank"
            rel="noopener noreferrer"
          >
            Firebase Console
          </a>
          ã«ã‚¢ã‚¯ã‚»ã‚¹
        </li>
        <li>ã€Œè¤‡åˆã€ã‚¿ãƒ–ã‚’é¸æŠ</li>
        <li>
          ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ:
          <ul>
            <li>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: <code>bonusPayments</code></li>
            <li>
              ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: <code>employeeId</code> (æ˜‡é †), <code>fiscalYear</code> (æ˜‡é †),
              <code>paymentDate</code> (æ˜‡é †)
            </li>
          </ul>
        </li>
        <li>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå®Œäº†å¾Œã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</li>
      </ol>
    </div>
  </div>

  <!-- æ³¨è¨˜ãƒ»è­¦å‘Šè¡¨ç¤º -->
  <div class="notes" *ngIf="limitNotes.length > 0">
    <h4>ğŸ“‹ çŠ¶æ³</h4>
    <ul>
      <li *ngFor="let note of limitNotes">{{ note }}</li>
    </ul>
  </div>
</div>
