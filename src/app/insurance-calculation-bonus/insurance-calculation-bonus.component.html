<button class="home-button" (click)="goBack()">戻る</button>

<h2 class="page-title">賞与 社会保険料計算</h2>

<div class="calculation-container">
  <!-- 従業員情報表示エリア -->
  <div class="employee-info-section" *ngIf="employeeInfo">
    <h3>従業員情報</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">従業員番号:</span>
        <span>{{ employeeInfo.employeeNumber }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">氏名:</span>
        <span>{{ employeeInfo.name }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">年齢:</span>
        <span>{{ employeeInfo.age }}歳</span>
      </div>
      <div class="info-item">
        <span class="info-label">事業所所在地:</span>
        <span>{{ employeeInfo.addressPrefecture }}</span>
      </div>
    </div>
  </div>

  <!-- 年度選択と取り込みエリア -->
  <div class="bonus-control-section">
    <h3>賞与情報取り込み</h3>

    <div class="control-form">
      <div class="form-row">
        <label for="target-year" class="form-label">対象年度:</label>
        <div class="year-controls">
          <button class="year-nav-btn" (click)="previousYear()">&lt;</button>
          <span class="current-year">{{ formatFiscalYear(targetYear) }}</span>
          <button class="year-nav-btn" (click)="nextYear()">&gt;</button>
          <button class="current-year-btn" (click)="currentYear()">現在年度</button>
        </div>
      </div>

      <div class="import-button-area">
        <button
          class="import-btn"
          (click)="importBonusData()"
          [disabled]="!employeeInfo || isLoading"
        >
          <span *ngIf="isLoading">読み込み中...</span>
          <span *ngIf="!isLoading">📥 賞与データ取り込み</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Excel形式の計算結果表 -->
  <div class="result-table-section">
    <h3>賞与社会保険料計算結果</h3>

    <div class="excel-table">
      <table>
        <thead>
          <tr class="header-row-1">
            <th rowspan="3">支給年月日</th>
            <th rowspan="3">報酬額</th>
            <th colspan="5">全国健康保険協会管掌健康保険料</th>
            <th colspan="3">厚生年金保険料（厚生年金基金加入員を除く）</th>
          </tr>
          <tr class="header-row-2">
            <th rowspan="2">等級</th>
            <th colspan="2">介護保険第2号被保険者<br />に該当しない場合</th>
            <th colspan="2">介護保険第2号被保険者<br />に該当する場合</th>
            <th rowspan="2">等級</th>
            <th colspan="2">一般、坑内員・船員</th>
          </tr>
          <tr class="header-row-3">
            <th>従業員負担</th>
            <th>会社負担</th>
            <th>従業員負担</th>
            <th>会社負担</th>
            <th>従業員負担</th>
            <th>会社負担</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bonus of bonusDataList; let i = index">
            <td>{{ bonus.paymentDate || '-' }}</td>
            <td>{{ bonus.amount ? formatAmount(bonus.amount) : '-' }}</td>
            <td>{{ bonus.healthInsuranceGrade || '-' }}</td>
            <!-- 40歳未満の場合（介護保険第2号被保険者に該当しない場合） -->
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age < 40; else nonNursingEmpty">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.employeeBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nonNursingEmpty>-</ng-template>
            </td>
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age < 40; else nonNursingEmpty2">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.companyBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nonNursingEmpty2>-</ng-template>
            </td>
            <!-- 40歳以上の場合（介護保険第2号被保険者に該当する場合） -->
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age >= 40; else nursingEmpty">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.employeeBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nursingEmpty>-</ng-template>
            </td>
            <td>
              <ng-container *ngIf="employeeInfo && employeeInfo.age >= 40; else nursingEmpty2">
                {{
                  bonus.calculationResult
                    ? formatAmount(bonus.calculationResult.healthInsurance.companyBurden)
                    : '-'
                }}
              </ng-container>
              <ng-template #nursingEmpty2>-</ng-template>
            </td>
            <td>{{ bonus.pensionInsuranceGrade || '-' }}</td>
            <td>
              {{
                bonus.calculationResult
                  ? formatAmount(bonus.calculationResult.pensionInsurance.employeeBurden)
                  : '-'
              }}
            </td>
            <td>
              {{
                bonus.calculationResult
                  ? formatAmount(bonus.calculationResult.pensionInsurance.companyBurden)
                  : '-'
              }}
            </td>
          </tr>
          <!-- データがない場合の空行表示 -->
          <tr *ngIf="bonusDataList.length === 0">
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 上限適用の注記 -->
    <div class="notes" *ngIf="hasLimitApplied">
      <h4>⚠️ 注記</h4>
      <ul>
        <li *ngFor="let note of limitNotes">{{ note }}</li>
      </ul>
    </div>
  </div>

  <!-- エラーメッセージ表示 -->
  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
    <div *ngIf="errorMessage.includes('インデックス')" class="index-guidance">
      <p><strong>解決方法:</strong></p>
      <ol>
        <li>
          <a
            href="https://console.firebase.google.com/project/kensyu10093/firestore/indexes"
            target="_blank"
            rel="noopener noreferrer"
          >
            Firebase Console
          </a>
          にアクセス
        </li>
        <li>「複合」タブを選択</li>
        <li>
          以下のインデックスを作成:
          <ul>
            <li>コレクション: <code>bonusPayments</code></li>
            <li>
              フィールド: <code>employeeId</code> (昇順), <code>fiscalYear</code> (昇順),
              <code>paymentDate</code> (昇順)
            </li>
          </ul>
        </li>
        <li>インデックス作成完了後、ページを再読み込み</li>
      </ol>
    </div>
  </div>

  <!-- 注記・警告表示 -->
  <div class="notes" *ngIf="limitNotes.length > 0">
    <h4>📋 状況</h4>
    <ul>
      <li *ngFor="let note of limitNotes">{{ note }}</li>
    </ul>
  </div>
</div>
