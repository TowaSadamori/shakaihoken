<div class="judgment-container">
  <div class="header-container">
    <button class="btn-back" (click)="goBack()">
      <i class="icon-arrow-left"></i>
      従業員一覧に戻る
    </button>
    <h2>社会保険対象者判定</h2>
  </div>

  <!-- 対象者情報 -->
  <div class="employee-info">
    <h3>対象者情報</h3>
    <div class="info-grid">
      <div class="info-item">
        <div class="label">従業員名:</div>
        <span>{{ employeeName }}</span>
      </div>
      <div class="info-item">
        <div class="label">従業員番号:</div>
        <span>{{ employeeNumber }}</span>
      </div>
      <div class="info-item">
        <div class="label">生年月日:</div>
        <span>{{ birthDate }}</span>
      </div>
      <div class="info-item">
        <div class="label">年齢:</div>
        <span>{{ age }}歳</span>
      </div>
      <div class="info-item">
        <div class="label">事業所番号:</div>
        <span>{{ officeNumber }}</span>
      </div>
      <div class="info-item">
        <div class="label">事業所所在地:</div>
        <span>{{ officePrefecture }}</span>
      </div>
    </div>
  </div>

  <!-- 属性編集ボタン -->
  <div class="attribute-edit-section" *ngIf="!showQuestionnaire && !judgmentResult">
    <div class="edit-prompt">
      <p>従業員の属性を設定するために質問に答えてください</p>
      <button class="btn-primary" (click)="startAttributeEdit()">属性を編集する</button>
    </div>
  </div>

  <!-- 質問エリア -->
  <div class="questionnaire" *ngIf="showQuestionnaire && currentQuestion">
    <h3>質問 {{ getQuestionNumber() }}</h3>

    <!-- デバッグ情報 -->
    <div
      class="debug-info"
      style="
        background: #fff3cd;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        position: relative;
      "
      *ngIf="showDebugInfo"
    >
      <button
        (click)="hideDebugInfo()"
        style="
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 3px;
          padding: 0.25rem 0.5rem;
          cursor: pointer;
        "
      >
        ✕ 閉じる
      </button>
      <strong>🔍 リアルタイムデバッグ情報:</strong><br />
      📋 現在の質問ID: {{ currentQuestionId }}<br />
      ❓ 現在の質問テキスト: {{ currentQuestion.text }}<br />
      📝 現在の質問の回答: {{ answers[currentQuestionId] }}<br />
      📚 質問履歴: {{ questionHistory | json }}<br />
      📊 履歴の長さ: {{ questionHistory.length }}<br />
      ⬅️ 戻ることができる: {{ canGoToPreviousQuestion }}<br />
      🔍 nextQuestion設定: {{ currentQuestion.nextQuestion | json }}<br />
      📝 全回答データ: {{ answers | json }}<br />
      🎯 雇用形態: {{ answers['employmentType'] }}<br />
      <button (click)="debugCurrentState()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem">
        詳細デバッグ
      </button>
    </div>

    <!-- 前の質問に戻るボタン -->
    <div class="question-navigation" *ngIf="canGoToPreviousQuestion">
      <button class="btn-previous" (click)="goToPreviousQuestion()">
        <i class="icon-arrow-left"></i>
        前の質問に戻る
      </button>
    </div>

    <div class="questions">
      <div class="question-item">
        <div class="question-text">{{ currentQuestion.text }}</div>

        <!-- 選択式質問 -->
        <div class="answer-options" *ngIf="currentQuestion.type === 'choice'">
          <label *ngFor="let choice of currentQuestion.choices">
            <input
              type="radio"
              [name]="currentQuestion.id"
              [value]="choice.value"
              [(ngModel)]="answers[currentQuestion.id]"
              (change)="updateAnswers()"
            />
            {{ choice.label }}
          </label>
        </div>

        <!-- はい/いいえ質問 -->
        <div class="answer-options" *ngIf="currentQuestion.type === 'yesno'">
          <label>
            <input
              type="radio"
              [name]="currentQuestion.id"
              value="yes"
              [(ngModel)]="answers[currentQuestion.id]"
              (change)="logChangeEvent('はい', currentQuestion.id); updateAnswers()"
              (click)="
                logRadioClick('はい', currentQuestion.id);
                handleRadioClick('yes', currentQuestion.id)
              "
            />
            はい
          </label>
          <label>
            <input
              type="radio"
              [name]="currentQuestion.id"
              value="no"
              [(ngModel)]="answers[currentQuestion.id]"
              (change)="logChangeEvent('いいえ', currentQuestion.id); updateAnswers()"
              (click)="
                logRadioClick('いいえ', currentQuestion.id);
                handleRadioClick('no', currentQuestion.id)
              "
            />
            いいえ
          </label>
        </div>

        <!-- 日付範囲質問 -->
        <div class="date-range-options" *ngIf="currentQuestion.type === 'date-range'">
          <div class="period-selection">
            <div class="date-input-section">
              <h4>期間を指定してください</h4>
              <div class="date-inputs">
                <div class="date-field">
                  <div class="field-label">開始日:</div>
                  <input type="date" #startDate class="date-input" />
                </div>
                <div class="date-field">
                  <div class="field-label">終了予定日:</div>
                  <input type="date" #endDate class="date-input" />
                </div>
              </div>
              <button
                class="period-button custom-button"
                (click)="updateDateRange(startDate.value, endDate.value)"
                [disabled]="!startDate.value || !endDate.value"
              >
                期間を設定して次へ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 判定結果 -->
  <div class="judgment-result" *ngIf="judgmentResult">
    <div class="result-header">
      <h3>判定結果</h3>
      <div class="result-buttons">
        <button class="btn-reset" (click)="resetQuestionnaire()">
          <i class="icon-refresh"></i>
          判定をやり直す
        </button>
        <button class="btn-save" (click)="saveJudgment()">
          <i class="icon-save"></i>
          判定結果を保存
        </button>
      </div>
    </div>

    <!-- 判定結果デバッグ情報 -->
    <div
      class="debug-info"
      style="
        background: #e7f3ff;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        position: relative;
      "
      *ngIf="showDebugInfo"
    >
      <button
        (click)="hideDebugInfo()"
        style="
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 3px;
          padding: 0.25rem 0.5rem;
          cursor: pointer;
        "
      >
        ✕ 閉じる
      </button>
      <strong>🔍 判定結果デバッグ情報:</strong><br />
      📝 全回答データ: {{ answers | json }}<br />
      🎯 雇用形態: {{ answers['employmentType'] }}<br />
      📚 質問履歴: {{ questionHistory | json }}<br />
      🏥 健康保険判定: {{ judgmentResult.healthInsurance | json }}<br />
      🏛️ 厚生年金判定: {{ judgmentResult.pensionInsurance | json }}<br />
      🧓 介護保険判定: {{ judgmentResult.careInsurance | json }}<br />
      📅 年齢: {{ age }}歳<br />
      🏢 休職状況: {{ answers['leaveStatus'] }}<br />
      📋 手入力健康保険: {{ answers['manualHealthInsurance'] }}<br />
      📋 手入力厚生年金: {{ answers['manualPensionInsurance'] }}<br />
      <button (click)="debugCurrentState()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem">
        詳細デバッグ
      </button>
    </div>

    <!-- 休職情報表示 -->
    <div class="leave-info" *ngIf="getLeaveInfo()">
      <h4>休職情報</h4>
      <div class="leave-details">
        <div class="leave-type">
          <span class="label">休職種別:</span>
          <span class="value">{{ getLeaveTypeLabel() }}</span>
        </div>
        <div class="leave-period" *ngIf="getLeavePeriodInfo()">
          <span class="label">免除期間:</span>
          <span class="value">{{ getLeavePeriodInfo() }}</span>
        </div>
      </div>
    </div>

    <div class="result-cards">
      <div class="result-card">
        <h4>健康保険料</h4>
        <div
          class="status"
          [class]="judgmentResult.healthInsurance.eligible ? 'eligible' : 'not-eligible'"
        >
          {{ judgmentResult.healthInsurance.eligible ? '加入対象' : '加入対象外' }}
        </div>
        <p>{{ judgmentResult.healthInsurance.reason }}</p>
      </div>

      <div class="result-card">
        <h4>介護保険料</h4>
        <div
          class="status"
          [class]="judgmentResult.careInsurance?.eligible ? 'eligible' : 'not-eligible'"
        >
          {{ judgmentResult.careInsurance?.eligible ? '加入対象' : '加入対象外' }}
        </div>
        <p>{{ judgmentResult.careInsurance?.reason }}</p>
      </div>

      <div class="result-card">
        <h4>厚生年金保険料</h4>
        <div
          class="status"
          [class]="judgmentResult.pensionInsurance.eligible ? 'eligible' : 'not-eligible'"
        >
          {{ judgmentResult.pensionInsurance.eligible ? '加入対象' : '加入対象外' }}
        </div>
        <p>{{ judgmentResult.pensionInsurance.reason }}</p>
      </div>
    </div>
  </div>

  <!-- 追加質問（社会保険加入対象者のみ） -->
  <div class="additional-questions" *ngIf="judgmentResult && isInsuranceEligible()">
    <div class="section-header">
      <h3>追加情報の入力</h3>
      <p>該当する事例がある場合は選択してください（任意）</p>
    </div>

    <div class="special-cases">
      <div class="case-item" *ngFor="let specialCase of selectedSpecialCases; let i = index">
        <div class="case-header" *ngIf="selectedSpecialCases.length > 1">
          <button class="btn-remove" (click)="removeSpecialCase(i)">
            <i class="icon-close"></i>
            削除
          </button>
        </div>

        <div class="case-selection">
          <label [for]="'case-type-' + i">事例の種類:</label>
          <select
            [id]="'case-type-' + i"
            [(ngModel)]="specialCase.type"
            (change)="onSpecialCaseTypeChange(i)"
          >
            <option value="">選択してください</option>
            <option value="maternity-leave">産前産後休業期間中の保険料免除</option>
            <option value="childcare-leave">育休</option>
            <option value="other-leave">その他の休職</option>
            <option value="secondment">出向者の社会保険加入</option>
            <option value="multiple-workplace">二以上事業所勤務者</option>
            <option value="same-day-acquisition-loss">同日得喪</option>
          </select>
        </div>

        <!-- 産前産後休業の詳細フォーム -->
        <div class="case-details" *ngIf="specialCase.type === 'maternity-leave'">
          <div class="form-grid">
            <div class="form-group">
              <label [for]="'pregnancy-type-' + i">妊娠の種類:</label>
              <select
                [id]="'pregnancy-type-' + i"
                [(ngModel)]="specialCase.details.pregnancyType"
                (change)="calculateMaternityPeriod(i)"
              >
                <option value="">選択してください</option>
                <option value="single">単胎</option>
                <option value="multiple">多胎</option>
              </select>
            </div>

            <div class="form-group">
              <label [for]="'expected-birth-date-' + i">出産予定日:</label>
              <input
                [id]="'expected-birth-date-' + i"
                type="date"
                [(ngModel)]="specialCase.details.expectedBirthDate"
                (change)="calculateMaternityPeriod(i)"
              />
            </div>

            <div class="form-group">
              <label [for]="'actual-birth-date-' + i">実際の出産日（任意）:</label>
              <input
                [id]="'actual-birth-date-' + i"
                type="date"
                [(ngModel)]="specialCase.details.actualBirthDate"
                (change)="calculateMaternityPeriod(i); onActualBirthDateChange(i)"
              />
            </div>

            <!-- 計算された最大期間表示 -->
            <div class="form-group full-width" *ngIf="getCalculatedMaternityPeriod(i)">
              <div class="calculated-period">
                <h5>法定最大期間（参考）</h5>
                <div class="period-info">
                  <div class="period-item">
                    <span class="label">産前期間:</span>
                    <span class="value">{{ getCalculatedMaternityPeriod(i)?.preNatalPeriod }}</span>
                  </div>
                  <div class="period-item">
                    <span class="label">産後期間:</span>
                    <span class="value">{{
                      getCalculatedMaternityPeriod(i)?.postNatalPeriod
                    }}</span>
                  </div>
                  <div class="period-item total">
                    <span class="label">最大免除期間:</span>
                    <span class="value">{{ getCalculatedMaternityPeriod(i)?.totalPeriod }}</span>
                  </div>
                  <div class="period-item exemption">
                    <span class="label">社会保険料免除期間:</span>
                    <span class="value">{{
                      getCalculatedMaternityPeriod(i)?.exemptionPeriod
                    }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 実際の申請期間選択 -->
            <div class="form-group full-width" *ngIf="getCalculatedMaternityPeriod(i)">
              <div class="actual-period-selection">
                <h5>実際の社会保険料免除期間</h5>

                <!-- 産前・産後期間の入力 -->
                <div class="period-breakdown">
                  <div class="period-section prenatal">
                    <div class="period-header">
                      <span class="period-title">産前の期間</span>
                      <div class="period-inputs">
                        <input
                          type="date"
                          [(ngModel)]="specialCase.details.preNatalStartDate"
                          [value]="specialCase.details.preNatalStartDate || getPreNatalStartDate(i)"
                          (ngModelChange)="onPreNatalStartDateChange(i, $event)"
                          class="period-date-input"
                          placeholder="開始日"
                        />
                        <span class="date-separator">～</span>
                        <input
                          type="date"
                          [(ngModel)]="specialCase.details.preNatalEndDate"
                          [value]="specialCase.details.preNatalEndDate || getPreNatalEndDate(i)"
                          (ngModelChange)="onPreNatalEndDateChange(i, $event)"
                          class="period-date-input"
                          placeholder="終了日"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="period-section postnatal">
                    <div class="period-header">
                      <span class="period-title">産後の期間</span>
                      <div class="period-inputs">
                        <input
                          type="date"
                          [(ngModel)]="specialCase.details.postNatalStartDate"
                          [value]="
                            specialCase.details.postNatalStartDate || getPostNatalStartDate(i)
                          "
                          (ngModelChange)="onPostNatalStartDateChange(i, $event)"
                          class="period-date-input"
                          placeholder="開始日"
                        />
                        <span class="date-separator">～</span>
                        <input
                          type="date"
                          [(ngModel)]="specialCase.details.postNatalEndDate"
                          [value]="specialCase.details.postNatalEndDate || getPostNatalEndDate(i)"
                          [min]="getPostNatalStartDate(i)"
                          [max]="getPostNatalMaxDate(i)"
                          (ngModelChange)="onPostNatalEndDateChange(i, $event)"
                          class="period-date-input"
                          placeholder="終了日"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 社会保険料免除期間の表示 -->
                <div class="exemption-period-display">
                  <div class="exemption-bar">
                    <span class="exemption-label">社会保険料免除期間:</span>
                    <span class="exemption-period">{{ getActualExemptionPeriod(i) }}</span>
                  </div>
                </div>

                <div
                  class="selected-period-info"
                  *ngIf="specialCase.details.actualStartDate && specialCase.details.actualEndDate"
                >
                  <div class="info-item">
                    <span class="label">選択された期間:</span>
                    <span class="value"
                      >{{ specialCase.details.actualStartDate }} ～
                      {{ specialCase.details.actualEndDate }}</span
                    >
                  </div>
                  <div class="info-item">
                    <span class="label">申請日数:</span>
                    <span class="value">{{ getSelectedPeriodDays(i) }}日間</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group full-width">
              <label [for]="'maternity-remarks-' + i">備考:</label>
              <textarea
                [id]="'maternity-remarks-' + i"
                [(ngModel)]="specialCase.details.remarks"
                placeholder="産前産後休業に関する特記事項など"
              ></textarea>
            </div>
          </div>

          <!-- 産前産後休業の保存ボタン -->
          <div class="case-save-section">
            <button
              class="btn-save-case"
              (click)="saveSpecialCase(i)"
              [disabled]="!canSaveMaternityCase(i)"
            >
              <i class="icon-save"></i>
              この情報を保存
            </button>
            <div class="save-status" *ngIf="specialCase.saveStatus">
              <span class="status-icon" [class]="specialCase.saveStatus">
                {{
                  specialCase.saveStatus === 'saved'
                    ? '✓'
                    : specialCase.saveStatus === 'saving'
                      ? '⏳'
                      : '✗'
                }}
              </span>
              <span class="status-text">
                {{ getSpecialCaseSaveStatusText(specialCase.saveStatus) }}
              </span>
            </div>
          </div>
        </div>

        <!-- 育休の詳細フォーム -->
        <div class="case-details" *ngIf="specialCase.type === 'childcare-leave'">
          <div class="form-grid">
            <div class="form-group">
              <label [for]="'childcare-start-' + i">開始日:</label>
              <input
                [id]="'childcare-start-' + i"
                type="date"
                [(ngModel)]="specialCase.details.startDate"
              />
            </div>

            <div class="form-group">
              <label [for]="'childcare-end-' + i">終了予定日:</label>
              <input
                [id]="'childcare-end-' + i"
                type="date"
                [(ngModel)]="specialCase.details.endDate"
              />
            </div>

            <div class="form-group full-width">
              <label [for]="'childcare-remarks-' + i">備考:</label>
              <textarea
                [id]="'childcare-remarks-' + i"
                [(ngModel)]="specialCase.details.remarks"
                placeholder="育休に関する特記事項など"
              ></textarea>
            </div>
          </div>

          <!-- 育休の保存ボタン -->
          <div class="case-save-section">
            <button
              class="btn-save-case"
              (click)="saveSpecialCase(i)"
              [disabled]="!canSaveChildcareCase(i)"
            >
              <i class="icon-save"></i>
              この情報を保存
            </button>
            <div class="save-status" *ngIf="specialCase.saveStatus">
              <span class="status-icon" [class]="specialCase.saveStatus">
                {{
                  specialCase.saveStatus === 'saved'
                    ? '✓'
                    : specialCase.saveStatus === 'saving'
                      ? '⏳'
                      : '✗'
                }}
              </span>
              <span class="status-text">
                {{ getSpecialCaseSaveStatusText(specialCase.saveStatus) }}
              </span>
            </div>
          </div>
        </div>

        <!-- その他の事例の簡易フォーム -->
        <div
          class="case-details"
          *ngIf="
            specialCase.type &&
            specialCase.type !== 'maternity-leave' &&
            specialCase.type !== 'childcare-leave'
          "
        >
          <div class="form-group full-width">
            <label [for]="'other-remarks-' + i">詳細・備考:</label>
            <textarea
              [id]="'other-remarks-' + i"
              [(ngModel)]="specialCase.details.remarks"
              [placeholder]="getPlaceholderText(specialCase.type)"
            ></textarea>
          </div>

          <!-- その他の事例の保存ボタン -->
          <div class="case-save-section">
            <button
              class="btn-save-case"
              (click)="saveSpecialCase(i)"
              [disabled]="!canSaveOtherCase(i)"
            >
              <i class="icon-save"></i>
              この情報を保存
            </button>
            <div class="save-status" *ngIf="specialCase.saveStatus">
              <span class="status-icon" [class]="specialCase.saveStatus">
                {{
                  specialCase.saveStatus === 'saved'
                    ? '✓'
                    : specialCase.saveStatus === 'saving'
                      ? '⏳'
                      : '✗'
                }}
              </span>
              <span class="status-text">
                {{ getSpecialCaseSaveStatusText(specialCase.saveStatus) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="add-case-section">
        <button class="btn-add-case" (click)="addSpecialCase()">
          <i class="icon-plus"></i>
          特殊事例を追加
        </button>
      </div>
    </div>
  </div>

  <!-- アクションボタン -->
  <div class="action-buttons" *ngIf="!judgmentResult">
    <!-- 判定結果がない時のみ表示 -->
  </div>
</div>
